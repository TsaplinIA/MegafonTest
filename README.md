# MegafonTest

## Задание 1 
### Описание

Linux.
Необходимо ежечасно по рабочим дням загружать файл с 1-го сервера на 500 серверов.
Список серверов, на которые не удалось выгрузить данные ,
отправляем письмом на mailbox@server.ru. Как это сделать с помощью bash?

### Решение
Я нечасто работал с такими задачами, а если и работал, то использовал python скрипты.
Тут задача не совсем на bash, а скорее на bash + cron + pscp.
Удостоверимся что у нас установлены все необходимые утилиты:
- cron
- pscp
- sendmail или postfix или другая утилита для отправки почты  

Скрипт запускается по cron каждый час, с понедельника по пятницу:
`0 * * * 1-5 /script.sh` (Нулевая минута каждого часа каждого дня каждого месяца, но только с понедельника по пятницу)
Скрипт примерно такой:
```bash
#!/bin/bash

# Конфигурационные параметры
source_server="source_server.example.com"
target_hosts_file="myscphosts.txt"
file_path="/путь/к/файлу"
email_recipient="mailbox@server.ru"

# Создаем временный файл для сохранения списка серверов с ошибками
error_servers_file="$(mktemp)"

# Загрузка файла на целевые хосты с использованием pscp и передачей списка хостов
pscp -q -h "$target_hosts_file" "$source_server:$file_path" . 2>&1 | tee "$error_servers_file" | grep "failure" > /dev/null

# Проверка кода возврата pscp
if [[ $? -eq 0 ]]; then
    # Если есть неудачные загрузки, отправляем содержимое временного файла в письме на указанный адрес электронной почты
    echo "Не удалось загрузить файл на следующие хосты:" >> "$error_servers_file"
    cat "$error_servers_file" | mail -s "Ошибка загрузки файла" "$email_recipient"
else
    echo "Все хосты успешно получили файл."
fi

# Удаление временного файла
rm "$error_servers_file"
```
При необходимости, вынести все "чувствительные" данные(smtp_password, например) в переменные окружения, чтобы безопасно доставлять скрипт на сервера.
